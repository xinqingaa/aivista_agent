# 优化日志系统并增强测试场景

## 一、目标

1. **清理冗余debug日志**：移除KnowledgeService和RAG Node中的大量debug日志
2. **保留Agent核心工作流日志**：Planner、RAG、Executor、Critic的关键日志
3. **增强preferredModel相关日志**：用于测试模型选择功能
4. **添加提示词日志**：显示推送给大模型的完整提示词
5. **提供测试场景**：覆盖各种测试需求

## 二、日志优化策略

### 2.1 日志级别规范

- **LOG级别**：Agent核心工作流的关键步骤（Planner识别意图、RAG检索结果、Executor执行、Critic审查）
- **DEBUG级别**：详细的调试信息（向量检索细节、数据库操作等）- 移除或改为LOG（仅关键信息）
- **WARN级别**：警告信息（检索失败但可降级处理）
- **ERROR级别**：错误信息（需要关注的问题）

### 2.2 需要优化的文件

1. **KnowledgeService** (`main/server/src/knowledge/knowledge.service.ts`)

   - 移除大量debug日志（向量维度、距离计算等）
   - 保留关键信息：检索结果数量、相似度

2. **RAG Node** (`main/server/src/agent/nodes/rag.node.ts`)

   - 移除debug日志（查询文本构建、过滤逻辑等）
   - 保留关键信息：检索到的风格、相似度

3. **Planner Node** (`main/server/src/agent/nodes/planner.node.ts`)

   - 增强日志：显示推送给LLM的系统提示词和用户输入

4. **Executor Node** (`main/server/src/agent/nodes/executor.node.ts`)

   - 增强日志：显示模型选择逻辑、推送给图片生成服务的完整提示词

5. **Critic Node** (`main/server/src/agent/nodes/critic.node.ts`)

   - 增强日志：显示质量审查的详细信息

6. **AgentController** (`main/server/src/agent/agent.controller.ts`)

   - 添加日志：显示接收到的请求参数（包括preferredModel）

## 三、实施任务

### 任务1: 优化KnowledgeService日志

**文件**: `main/server/src/knowledge/knowledge.service.ts`

**变更内容**:

- 移除所有 `logger.debug()` 调用（向量维度、距离计算、结果字段检查等）
- 保留关键 `logger.log()`：检索结果数量、相似度范围
- 简化日志输出，只显示关键信息

**示例**:

```typescript
// 移除前
this.logger.debug(`Knowledge base contains ${styles.length} styles`);
this.logger.debug(`Search query: "${queryText}", vector dimension: ${vector.length}, first 3 values: [${vector.slice(0, 3).map(v => v.toFixed(4)).join(', ')}]`);
this.logger.debug(`Raw search results count: ${results.length}`);
this.logger.debug(`First result keys: ${Object.keys(results[0] || {}).join(', ')}`);
this.logger.debug(`Using distance field for similarity calculation: distance=${distance}, similarity=${similarity.toFixed(4)}`);

// 优化后
this.logger.log(`Retrieved ${validResults.length} styles for query: "${queryText}" (similarities: ${similarities.join(', ')})`);
```

### 任务2: 优化RAG Node日志

**文件**: `main/server/src/agent/nodes/rag.node.ts`

**变更内容**:

- 移除所有 `logger.debug()` 调用（查询文本构建、过滤逻辑等）
- 保留关键 `logger.log()`：检索结果、风格名称、相似度
- 添加日志：显示增强后的最终Prompt

**示例**:

```typescript
// 移除
this.logger.debug(`RAG Node: Using style-focused query: "${queryText}"`);
this.logger.debug(`RAG Node: Query text: "${queryText}", minSimilarity: ${minSimilarity}, limit: ${searchLimit}`);
this.logger.debug(`RAG Node: Filtered results to prioritize matched style "${styleEnglish}", filtered count: ${results.length}`);

// 保留并增强
this.logger.log(`RAG Node: Retrieved ${results.length} styles: ${styleNames} (similarities: ${similarityScores})`);
this.logger.log(`RAG Node: Enhanced prompt - Original: "${originalPrompt}" -> Final: "${finalPrompt}"`);
```

### 任务3: 增强Planner Node日志

**文件**: `main/server/src/agent/nodes/planner.node.ts`

**变更内容**:

- 添加日志：显示推送给LLM的系统提示词（摘要）
- 添加日志：显示用户输入
- 增强日志：显示解析后的意图详情

**示例**:

```typescript
this.logger.log(`Planner Node: User input - "${state.userInput.text}"`);
this.logger.log(`Planner Node: Sending to LLM - System prompt (${systemPrompt.length} chars), User message`);
const intent = await this.llmService.chatWithJson<IntentResult>(messages);
this.logger.log(`Planner Node: Intent parsed - action: ${intent.action}, subject: ${intent.subject || 'N/A'}, style: ${intent.style || 'N/A'}, confidence: ${intent.confidence}`);
```

### 任务4: 增强Executor Node日志

**文件**: `main/server/src/agent/nodes/executor.node.ts`

**变更内容**:

- 添加日志：显示模型选择逻辑和结果
- 添加日志：显示推送给图片生成服务的完整提示词和参数
- 添加日志：显示preferredModel的使用情况

**示例**:

```typescript
// 在generate_image case中
this.logger.log(`Executor Node: Model selection - preferredModel: ${state.userInput.preferredModel || 'not specified'}, env config: ${this.configService.get('ALIYUN_IMAGE_MODEL') || 'not set'}, selected: ${model}`);
this.logger.log(`Executor Node: Image generation params - model: ${model}, size: ${size}, prompt: "${prompt.substring(0, 100)}${prompt.length > 100 ? '...' : ''}"`);
```

### 任务5: 增强Critic Node日志

**文件**: `main/server/src/agent/nodes/critic.node.ts`

**变更内容**:

- 增强日志：显示质量审查的详细评估信息
- 添加日志：显示审查使用的参数（passThreshold、useLlm等）

**示例**:

```typescript
this.logger.log(`Critic Node: Quality check params - passThreshold: ${passThreshold}, useLlm: ${useLlm}, retryCount: ${currentRetryCount}/${maxRetryCount}`);
// 在审查完成后
this.logger.log(`Critic Node: Quality check result - score: ${qualityCheck.score.toFixed(2)}, passed: ${qualityCheck.passed}, feedback: "${qualityCheck.feedback}"`);
```

### 任务6: 增强AgentController日志

**文件**: `main/server/src/agent/agent.controller.ts`

**变更内容**:

- 添加日志：显示接收到的请求参数（包括preferredModel）

**示例**:

```typescript
this.logger.log(`AgentController: Received request - text: "${request.text.substring(0, 50)}${request.text.length > 50 ? '...' : ''}", preferredModel: ${request.preferredModel || 'not specified'}, hasMaskData: ${!!request.maskData}`);
```

### 任务7: 增强AliyunImageService日志

**文件**: `main/server/src/image/services/aliyun-image.service.ts`

**变更内容**:

- 增强日志：显示推送给DashScope API的完整请求参数（摘要）

**示例**:

```typescript
this.logger.log(`AliyunImageService: Request to DashScope - model: ${model}, size: ${size}, prompt: "${prompt.substring(0, 100)}${prompt.length > 100 ? '...' : ''}", prompt_extend: ${promptExtend}`);
```

## 四、测试场景建议

### 场景1: 不提供preferredModel（使用环境变量默认值）

**请求**:

```json
{
  "text": "生成一只赛博朋克风格的猫"
}
```

**预期日志**:

- AgentController: preferredModel: not specified
- Executor Node: Model selection - preferredModel: not specified, env config: qwen-image-plus, selected: qwen-image-plus
- AliyunImageService: Request to DashScope - model: qwen-image-plus

### 场景2: 提供preferredModel（使用用户指定模型）

**请求**:

```json
{
  "text": "生成一只赛博朋克风格的狗",
  "preferredModel": "qwen-image-max"
}
```

**预期日志**:

- AgentController: preferredModel: qwen-image-max
- Executor Node: Model selection - preferredModel: qwen-image-max, env config: qwen-image-plus, selected: qwen-image-max
- AliyunImageService: Request to DashScope - model: qwen-image-max

### 场景3: 无效的preferredModel值（验证器测试）

**请求**:

```json
{
  "text": "生成一只猫",
  "preferredModel": "invalid-model"
}
```

**预期**:

- 应该返回400错误，验证器拒绝无效值
- 日志显示验证失败

### 场景4: 不同风格的测试

**请求列表**:

1. `"生成一只水彩风格的猫"`
2. `"生成一幅极简主义的城市风景"`
3. `"生成一张油画风格的人物肖像"`
4. `"生成一个动漫风格的机器人"`

**预期日志**:

- RAG Node: 显示检索到的不同风格
- 显示增强后的Prompt（包含风格关键词）

### 场景5: 局部重绘测试

**请求**:

```json
{
  "text": "将背景改为星空",
  "maskData": {
    "base64": "...",
    "imageUrl": "https://..."
  }
}
```

**预期日志**:

- Planner Node: 检测到蒙版数据，已识别为局部重绘任务
- Executor Node: 使用editImage方法

### 场景6: 质量审查测试（触发重试）

**配置**: `CRITIC_PASS_THRESHOLD=0.9` (提高阈值，更容易触发重试)

**请求**:

```json
{
  "text": "生成一只猫"
}
```

**预期日志**:

- Critic Node: 显示质量审查结果
- 如果未通过，显示重试信息

### 场景7: 不同模型切换测试

**请求序列**:

1. `{"text": "生成一只猫", "preferredModel": "qwen-image"}`
2. `{"text": "生成一只狗", "preferredModel": "qwen-image-max"}`
3. `{"text": "生成一只鸟", "preferredModel": "qwen-image-plus"}`
4. `{"text": "生成一只鱼", "preferredModel": "z-image-turbo"}`

**预期日志**:

- 每次请求都显示正确的模型选择
- AliyunImageService显示使用不同模型

## 五、实施顺序

1. 优化KnowledgeService日志（移除debug日志）
2. 优化RAG Node日志（移除debug日志，增强关键信息）
3. 增强Planner Node日志（添加提示词日志）
4. 增强Executor Node日志（添加模型选择和提示词日志）
5. 增强Critic Node日志（添加详细审查信息）
6. 增强AgentController日志（添加请求参数日志）
7. 增强AliyunImageService日志（添加API请求日志）
8. 测试验证所有场景

## 六、注意事项

1. **保持日志简洁**：只保留关键信息，避免日志过多
2. **敏感信息**：API Key等敏感信息不要记录
3. **性能考虑**：日志操作不应影响性能
4. **可读性**：日志格式统一，易于阅读和搜索
5. **测试友好**：关键测试点都有对应的日志输出

## 七、日志输出示例

优化后的典型日志输出：

```
[AgentController] Received request - text: "生成一只赛博朋克风格的猫", preferredModel: not specified, hasMaskData: false
[PlannerNode] User input - "生成一只赛博朋克风格的猫"
[PlannerNode] Sending to LLM - System prompt (456 chars), User message
[PlannerNode] Intent parsed - action: generate_image, subject: 猫, style: 赛博朋克, confidence: 0.95
[RagNode] RAG Node: Starting style retrieval...
[RagNode] Retrieved 1 styles: Cyberpunk (similarities: 0.57)
[RagNode] Enhanced prompt - Original: "生成一只赛博朋克风格的猫" -> Final: "生成一只赛博朋克风格的猫, neon lights, high tech, low life, dark city background, futuristic, cyberpunk aesthetic, vibrant colors, urban decay"
[ExecutorNode] Model selection - preferredModel: not specified, env config: qwen-image-plus, selected: qwen-image-plus
[ExecutorNode] Image generation params - model: qwen-image-plus, size: 1024x1024, prompt: "生成一只赛博朋克风格的猫, neon lights, high tech, low life, dark city background..."
[AliyunImageService] Request to DashScope - model: qwen-image-plus, size: 1024*1024, prompt: "生成一只赛博朋克风格的猫, neon lights...", prompt_extend: true
[AliyunImageService] Image generated successfully: https://...
[ExecutorNode] Generated image URL - https://...
[CriticNode] Quality check params - passThreshold: 0.7, useLlm: false, retryCount: 0/3
[CriticNode] Quality check result - score: 0.93, passed: true, feedback: "图片质量符合要求"
```