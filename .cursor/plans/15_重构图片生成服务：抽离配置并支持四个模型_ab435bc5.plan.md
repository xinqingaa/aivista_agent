---
name: 重构图片生成服务：抽离配置并支持四个模型
overview: 将 API endpoint 等硬编码值抽离到环境变量，创建四个独立的图片生成方法分别对应四个模型（qwen-image、qwen-image-max、qwen-image-plus、z-image-turbo），保持 Mock 作为兜底方案。
todos:
  - id: update-config-env
    content: 更新配置项：添加 DASHSCOPE_BASE_URL、DASHSCOPE_IMAGE_ENDPOINT 等环境变量
    status: completed
  - id: update-interface
    content: 更新图片生成服务接口：添加四个独立方法定义
    status: completed
  - id: refactor-service
    content: 重构 AliyunImageService：抽离配置、实现四个独立方法、处理参数差异
    status: completed
  - id: update-executor
    content: 更新 Executor Node：根据配置选择使用哪个模型方法
    status: completed
  - id: update-env-example
    content: 更新 .env.example：添加图片生成服务配置示例
    status: completed
---

# 重构图片生成服务：抽离配置并支持四个模型

## 一、目标

1. 将 API endpoint 等硬编码值抽离到环境变量
2. 创建四个独立的图片生成方法，分别对应四个模型
3. 保持 Mock 作为兜底方案
4. 方便切换不同模型

## 二、工作量评估

**总预计工作量：3-4 小时**

- 更新接口定义：15 分钟
- 抽离配置到环境变量：30 分钟
- 实现四个独立方法：1.5-2 小时
- 更新 Executor Node：30 分钟
- 更新配置验证：15 分钟
- 测试和调整：30 分钟

## 三、实施任务

### 任务 1: 更新配置项（环境变量）

**文件**:

- `main/server/src/config/configuration.ts`
- `main/server/.env.example`

**新增配置项**:

```typescript
// DashScope API 基础 URL（可配置，支持不同地域）
DASHSCOPE_BASE_URL?: string; // 默认: https://dashscope.aliyuncs.com/api/v1

// 图片生成 API endpoint（可配置）
DASHSCOPE_IMAGE_ENDPOINT?: string; // 默认: /services/aigc/multimodal-generation/generation

// 默认图片生成模型（用于 Executor Node 选择）
ALIYUN_IMAGE_MODEL?: 'qwen-image' | 'qwen-image-max' | 'qwen-image-plus' | 'z-image-turbo';

// 图片生成尺寸（默认）
ALIYUN_IMAGE_SIZE?: string; // 默认: 1024x1024

// 图片生成参数（可选）
ALIYUN_IMAGE_PROMPT_EXTEND?: boolean; // 默认: true（z-image-turbo 使用 false）
ALIYUN_IMAGE_WATERMARK?: boolean; // 默认: false
```

**预计工作量**: 30 分钟

---

### 任务 2: 更新图片生成服务接口

**文件**: `main/server/src/image/interfaces/image-service.interface.ts`

**变更内容**:

1. 更新 `ImageGenerationOptions`，支持四个模型
2. 添加四个独立的文生图方法（可选，或保持一个方法）
3. 保持 `editImage` 方法不变

**方案选择**: 根据用户选择，创建四个独立方法

**接口定义**:

```typescript
export interface IImageService {
  // 方案：四个独立方法
  generateImageQwenImage(prompt: string, options?: Omit<ImageGenerationOptions, 'model'>): Promise<string>;
  generateImageQwenImageMax(prompt: string, options?: Omit<ImageGenerationOptions, 'model'>): Promise<string>;
  generateImageQwenImagePlus(prompt: string, options?: Omit<ImageGenerationOptions, 'model'>): Promise<string>;
  generateImageZImageTurbo(prompt: string, options?: Omit<ImageGenerationOptions, 'model'>): Promise<string>;
  
  // 保持原有方法作为统一入口（内部根据配置选择）
  generateImage(prompt: string, options?: ImageGenerationOptions): Promise<string>;
  
  // 局部重绘
  editImage(prompt: string, options: ImageEditOptions): Promise<string>;
}

export interface ImageGenerationOptions {
  model?: 'qwen-image' | 'qwen-image-max' | 'qwen-image-plus' | 'z-image-turbo';
  size?: string;
  n?: number;
  prompt_extend?: boolean; // z-image-turbo 使用 false
  watermark?: boolean;
  negative_prompt?: string;
}
```

**预计工作量**: 15 分钟

---

### 任务 3: 重构 AliyunImageService

**文件**: `main/server/src/image/services/aliyun-image.service.ts`

**变更内容**:

1. 从环境变量读取 API endpoint 和配置
2. 创建四个独立的图片生成方法
3. 提取公共的 HTTP 请求逻辑
4. 处理不同模型的参数差异（如 z-image-turbo 的 prompt_extend=false）

**代码结构**:

```typescript
@Injectable()
export class AliyunImageService implements IImageService {
  private readonly apiKey: string;
  private readonly baseUrl: string;
  private readonly endpoint: string;
  private readonly defaultSize: string;
  private readonly defaultPromptExtend: boolean;
  private readonly defaultWatermark: boolean;

  constructor(private configService: ConfigService) {
    this.apiKey = this.configService.get<string>('DASHSCOPE_API_KEY') || '';
    this.baseUrl = this.configService.get<string>('DASHSCOPE_BASE_URL') 
      || 'https://dashscope.aliyuncs.com/api/v1';
    this.endpoint = this.configService.get<string>('DASHSCOPE_IMAGE_ENDPOINT')
      || '/services/aigc/multimodal-generation/generation';
    this.defaultSize = this.configService.get<string>('ALIYUN_IMAGE_SIZE') || '1024x1024';
    this.defaultPromptExtend = this.configService.get<boolean>('ALIYUN_IMAGE_PROMPT_EXTEND') ?? true;
    this.defaultWatermark = this.configService.get<boolean>('ALIYUN_IMAGE_WATERMARK') ?? false;
  }

  // 四个独立方法
  async generateImageQwenImage(prompt: string, options?: Omit<ImageGenerationOptions, 'model'>): Promise<string> {
    return this.generateImageInternal('qwen-image', prompt, options);
  }

  async generateImageQwenImageMax(prompt: string, options?: Omit<ImageGenerationOptions, 'model'>): Promise<string> {
    return this.generateImageInternal('qwen-image-max', prompt, options);
  }

  async generateImageQwenImagePlus(prompt: string, options?: Omit<ImageGenerationOptions, 'model'>): Promise<string> {
    return this.generateImageInternal('qwen-image-plus', prompt, options);
  }

  async generateImageZImageTurbo(prompt: string, options?: Omit<ImageGenerationOptions, 'model'>): Promise<string> {
    // z-image-turbo 默认 prompt_extend=false
    return this.generateImageInternal('z-image-turbo', prompt, {
      ...options,
      prompt_extend: options?.prompt_extend ?? false,
    });
  }

  // 统一入口方法（根据配置选择）
  async generateImage(prompt: string, options?: ImageGenerationOptions): Promise<string> {
    const model = options?.model || this.configService.get<string>('ALIYUN_IMAGE_MODEL') || 'qwen-image-plus';
    return this.generateImageInternal(model as any, prompt, options);
  }

  // 内部实现方法（提取公共逻辑）
  private async generateImageInternal(
    model: 'qwen-image' | 'qwen-image-max' | 'qwen-image-plus' | 'z-image-turbo',
    prompt: string,
    options?: Omit<ImageGenerationOptions, 'model'>,
  ): Promise<string> {
    // 统一的 HTTP 请求逻辑
  }
}
```

**参数差异处理**:

- `qwen-image`、`qwen-image-max`、`qwen-image-plus`: `prompt_extend=true`（默认）
- `z-image-turbo`: `prompt_extend=false`（根据示例）

**预计工作量**: 1.5-2 小时

---

### 任务 4: 更新 Executor Node

**文件**: `main/server/src/agent/nodes/executor.node.ts`

**变更内容**:

1. 根据环境变量 `ALIYUN_IMAGE_MODEL` 选择使用哪个方法
2. 或保持现有逻辑，通过 options.model 传递

**代码示例**:

```typescript
// 方案 A: 根据配置选择方法
const model = this.configService.get<'qwen-image' | 'qwen-image-max' | 'qwen-image-plus' | 'z-image-turbo'>('ALIYUN_IMAGE_MODEL') || 'qwen-image-plus';

let imageUrl: string;
switch (model) {
  case 'qwen-image':
    imageUrl = await this.imageService.generateImageQwenImage(prompt, { size: '1024x1024' });
    break;
  case 'qwen-image-max':
    imageUrl = await this.imageService.generateImageQwenImageMax(prompt, { size: '1024x1024' });
    break;
  case 'qwen-image-plus':
    imageUrl = await this.imageService.generateImageQwenImagePlus(prompt, { size: '1024x1024' });
    break;
  case 'z-image-turbo':
    imageUrl = await this.imageService.generateImageZImageTurbo(prompt, { size: '1024x1024' });
    break;
  default:
    throw new Error(`Unknown model: ${model}`);
}

// 方案 B: 保持现有方式，通过 options 传递
imageUrl = await this.imageService.generateImage(prompt, {
  model: model,
  size: '1024x1024',
});
```

**推荐**: 方案 B（更灵活，代码更简洁）

**预计工作量**: 30 分钟

---

### 任务 5: 更新 .env.example

**文件**: `main/server/.env.example`

**新增配置示例**:

```bash
# ============================================
# 图片生成服务配置
# ============================================
# 是否使用真实图片生成服务（默认 false，使用 Mock）
USE_REAL_IMAGE_SERVICE=false

# DashScope API 配置
DASHSCOPE_BASE_URL=https://dashscope.aliyuncs.com/api/v1
DASHSCOPE_IMAGE_ENDPOINT=/services/aigc/multimodal-generation/generation

# 默认图片生成模型（qwen-image | qwen-image-max | qwen-image-plus | z-image-turbo）
ALIYUN_IMAGE_MODEL=qwen-image-plus

# 图片生成尺寸（默认 1024x1024）
ALIYUN_IMAGE_SIZE=1024x1024

# 图片生成参数
ALIYUN_IMAGE_PROMPT_EXTEND=true  # z-image-turbo 使用 false
ALIYUN_IMAGE_WATERMARK=false
```

**预计工作量**: 15 分钟

---

## 四、技术要点

### 4.1 API Endpoint 配置

**完整 URL 构建**:

```typescript


const fullEndpoint = `${this.baseUrl}${this.endpoint}`;
// 默认: https://dashscope.aliyuncs.com/api/v1/services/aigc/multimodal-generation/generation
```

**支持不同地域**:

- 中国内地: `https://dashscope.aliyuncs.com/api/v1`
- 新加坡: `https://dashscope-intl.aliyuncs.com/api/v1`

### 4.2 模型参数差异

根据用户提供的示例：

| 模型 | prompt_extend 默认值 | 其他差异 |

|------|---------------------|---------|

| qwen-image | true | - |

| qwen-image-max | true | - |

| qwen-image-plus | true | - |

| z-image-turbo | false | 根据示例 |

### 4.3 错误处理和降级

- API 调用失败时，可以选择降级到 Mock（可选实现）
- 或直接抛出错误，由上层处理

---

## 五、实施顺序

1. 更新配置项（环境变量定义）
2. 更新接口定义
3. 重构 AliyunImageService（抽离配置、实现四个方法）
4. 更新 Executor Node
5. 更新 .env.example
6. 测试验证

---

## 六、注意事项

1. **向后兼容**: 保持 `generateImage` 方法作为统一入口，确保现有代码不破坏
2. **配置优先级**: 环境变量 > 代码默认值
3. **参数差异**: 注意不同模型的参数差异（如 prompt_extend）
4. **Mock 兜底**: 确保 Mock 服务正常工作
5. **错误处理**: API 调用失败时的处理策略

---

## 七、后续优化（可选）

1. **智能选择**: 根据用户意图自动选择最适合的模型
2. **成本优化**: 根据成本选择模型（qwen-image-plus 最便宜）
3. **性能监控**: 记录不同模型的调用次数和成功率
4. **缓存机制**: 相同 Prompt 缓存结果