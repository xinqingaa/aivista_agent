---
name: 工作流程文档与RAG优化
overview: 生成完整的工作流程文档，优化 RAG 检索逻辑（降低阈值、改进查询构建），并添加知识库管理 API 用于查看和调试。
todos: []
---

# 工作流程文档生成与 RAG 优化计划

## 1. 工作流程文档生成

### 1.1 创建主工作流程文档

**文件**: `main/server/docs/WORKFLOW_GUIDE.md`

**内容结构**:

- **概述**: 系统整体工作流程（Planner → RAG → Executor）
- **流程图**: 使用 Mermaid 图表展示完整流程
- **知识库内容展示**: 直接在文档中展示完整的 5 条风格数据表格
  - 包含：ID、风格名称（中英文）、Prompt、描述、标签、分类、流行度
  - 便于开发者快速了解知识库内容
- **节点详解**:
  - Planner Node: 意图识别流程、输入输出、示例
  - RAG Node: 向量检索流程、查询构建、相似度计算、知识库数据引用
  - Executor Node: 任务执行流程、GenUI 组件生成
- **数据流转**: AgentState 在各节点间的变化
- **SSE 事件流**: 事件类型、时序、示例响应
- **实际案例**: "生成一只赛博朋克风格的猫" 的完整流程追踪
- **本地数据库查看方法**: 
  - 数据库文件位置：`main/server/data/lancedb/styles.lance/`
  - 如何查看数据库内容（使用 API 或命令行工具）
  - 数据文件结构说明

### 1.2 更新现有文档

**文件**: `main/server/docs/PROMPT_README.md`

- 在工作流程章节添加流程图链接
- 补充 RAG 检索的详细说明

## 2. RAG 检索优化

### 2.1 降低相似度阈值

**文件**: `main/server/src/agent/nodes/rag.node.ts`

- 将 `minSimilarity` 从 `0.6` 降低到 `0.4`（提高召回率）
- 添加配置项支持环境变量 `RAG_MIN_SIMILARITY`（默认 0.4）

### 2.2 改进查询文本构建

**文件**: `main/server/src/agent/nodes/rag.node.ts`

**优化策略**:

- 如果 `intent.style` 存在，优先使用风格关键词
- 构建中英文混合查询：`${style} ${styleEnglish} ${subject}`
- 添加风格名称映射（中文 → 英文）：
  ```typescript
  const styleMap: Record<string, string> = {
    '赛博朋克': 'Cyberpunk',
    '水彩': 'Watercolor',
    '极简': 'Minimalist',
    '油画': 'Oil Painting',
    '动漫': 'Anime',
  };
  ```

- 如果检索失败，尝试使用英文风格名称再次检索

### 2.3 增强日志输出

**文件**: `main/server/src/agent/nodes/rag.node.ts`

- 记录查询文本、检索结果数量、相似度分数
- 如果检索失败，记录失败原因（阈值过滤、无结果等）

## 3. 知识库管理 API

### 3.1 创建知识库控制器

**文件**: `main/server/src/knowledge/knowledge.controller.ts`

**API 端点**:

- `GET /api/knowledge/styles` - 获取所有风格列表
- `GET /api/knowledge/styles/:id` - 获取单个风格详情
- `GET /api/knowledge/search?query=xxx` - 测试检索功能
- `GET /api/knowledge/stats` - 获取知识库统计信息（总数、维度等）
- `POST /api/knowledge/styles` - 添加新风格（可选，用于未来扩展）

### 3.2 更新知识库模块

**文件**: `main/server/src/knowledge/knowledge.module.ts`

- 注册 `KnowledgeController`
- 导出 `KnowledgeService` 供其他模块使用

### 3.3 添加 DTO 和 Swagger 文档

**文件**: `main/server/src/knowledge/knowledge.controller.ts`

- 使用 `@ApiTags('Knowledge')` 标记
- 为每个端点添加 Swagger 文档
- 定义响应 DTO 类型

## 4. 配置更新

### 4.1 环境变量配置

**文件**: `main/server/src/config/configuration.ts`

- 添加 `RAG_MIN_SIMILARITY` 配置项（默认 0.4）
- 添加 `RAG_SEARCH_LIMIT` 配置项（默认 3）

**文件**: `main/server/.env.example`

- 添加 RAG 相关配置说明

## 5. 文档更新

### 5.1 更新知识库文档

**文件**: `main/server/docs/KNOWLEDGE_BASE_INIT.md`

- **直接展示知识库内容**: 在文档开头添加完整的 5 条风格数据表格
- 添加管理 API 使用说明
- **本地数据库查看指南**:
  - 数据库文件路径：`main/server/data/lancedb/styles.lance/`
  - 使用管理 API 查看（推荐）：`GET /api/knowledge/styles`
  - 数据库文件结构说明（manifest、versions、transactions）
  - 如何验证数据是否正确初始化
- 添加调试和排查指南

### 5.2 更新 API 文档

**文件**: `main/server/docs/APIFOX_IMPORT.md`

- 添加知识库管理 API 的导入说明

## 实施顺序

1. **工作流程文档** - 先完成文档，包含知识库内容展示和查看方法
2. **RAG 优化** - 修复检索问题，确保功能正常
3. **管理 API** - 添加调试工具，方便通过 API 查看知识库内容
4. **配置和文档更新** - 完善配置说明和使用文档，更新知识库文档

## 6. 知识库内容文档化

### 6.1 在工作流程文档中展示知识库

**文件**: `main/server/docs/WORKFLOW_GUIDE.md`

**添加知识库数据表格**:

- 使用 Markdown 表格展示 5 条风格数据
- 包含字段：ID、风格名称、中文名称、Prompt、描述、标签、分类、流行度
- 便于开发者快速查阅知识库内容

**示例表格结构**:

| ID | 风格名称 | 中文名称 | Prompt (部分) | 描述 | 标签 | 分类 | 流行度 |

|----|---------|---------|--------------|------|------|------|--------|

| style_001 | Cyberpunk | 赛博朋克 | neon lights, high tech... | 赛博朋克风格：霓虹灯... | cyberpunk, futuristic | digital | 85 |

### 6.2 更新知识库初始化文档

**文件**: `main/server/docs/KNOWLEDGE_BASE_INIT.md`

**在文档开头添加**:

- 完整的数据表格（与工作流程文档一致）
- 数据来源说明：`main/server/src/knowledge/data/initial-styles.ts`

**添加本地数据库查看章节**:

- **方法 1 - 使用管理 API**（推荐）:
  ```
  GET http://localhost:3000/api/knowledge/styles
  ```

  - 返回所有风格数据（JSON 格式）
  - 可以在浏览器、Postman、Apifox 中直接查看

- **方法 2 - 查看数据库文件**:
  - 数据库路径：`main/server/data/lancedb/styles.lance/`
  - 文件结构说明：
    - `_latest.manifest`: 最新版本的清单文件
    - `_versions/`: 版本历史
    - `_transactions/`: 事务日志
  - 注意：LanceDB 文件是二进制格式，不建议直接查看文件内容

- **方法 3 - 使用命令行工具**（如果安装了 LanceDB CLI）:
  ```bash
  # 查看数据库信息
  lancedb list ./data/lancedb
  
  # 查询数据（需要安装 lancedb CLI）
  # 注意：此工具可能不适用于所有版本
  ```


### 6.3 在 README 中添加知识库快速参考

**文件**: `main/server/README.md`

- 添加"知识库快速参考"章节
- 链接到工作流程文档和知识库初始化文档
- 提供快速查看 API 的 curl 示例

## 关键文件清单

### 新建文件

- `main/server/docs/WORKFLOW_GUIDE.md` - 主工作流程文档（包含知识库内容展示）
- `main/server/src/knowledge/knowledge.controller.ts` - 知识库管理 API

### 修改文件

- `main/server/src/agent/nodes/rag.node.ts` - RAG 检索优化
- `main/server/src/knowledge/knowledge.module.ts` - 注册控制器
- `main/server/src/config/configuration.ts` - 添加 RAG 配置项
- `main/server/.env.example` - 添加 RAG 配置说明
- `main/server/docs/PROMPT_README.md` - 更新工作流程说明
- `main/server/docs/KNOWLEDGE_BASE_INIT.md` - 添加知识库内容展示和查看方法
- `main/server/README.md` - 添加知识库快速参考