---
name: 后端开发环境初始化
overview: 初始化 NestJS 后端项目，实现基础版本：包含 Planner Node、Executor Node（Mock）、基础 SSE 流式响应，确保可以在浏览器或 Apifox 中测试验证。
todos:
  - id: init_project
    content: 创建 NestJS 项目结构和配置文件
    status: completed
  - id: install_deps
    content: 安装所有必要的依赖包
    status: completed
    dependencies:
      - init_project
  - id: create_env
    content: 创建 .env.example 和环境变量配置
    status: completed
  - id: llm_service
    content: 实现 LLM 服务层（接口、阿里云实现、工厂）
    status: completed
    dependencies:
      - install_deps
  - id: agent_basic
    content: 实现基础 Agent（Controller、Service、State）
    status: completed
    dependencies:
      - llm_service
  - id: planner_node
    content: 实现 Planner Node（调用 LLM 解析意图）
    status: completed
    dependencies:
      - agent_basic
  - id: executor_node
    content: 实现 Executor Node（Mock 图片生成）
    status: completed
    dependencies:
      - planner_node
  - id: sse_streaming
    content: 实现 SSE 流式响应（思考日志、GenUI 组件）
    status: completed
    dependencies:
      - executor_node
  - id: test_verify
    content: 测试验证：确保服务可启动，API 可访问
    status: completed
    dependencies:
      - sse_streaming
---

# 后端开发环境初始化计划

## 目标

初始化 NestJS 后端项目，实现基础可用版本，支持：

- LLM 服务调用（阿里云通义千问）
- 基础的 Agent 工作流（Planner + Executor）
- SSE 流式响应
- 可在浏览器或 Apifox 中测试

## 实施步骤

### 阶段1：项目初始化

1. 创建 NestJS 项目结构
2. 安装核心依赖包
3. 配置 TypeScript 和基础设置

### 阶段2：配置和环境

1. 创建 `.env.example` 文件
2. 配置环境变量加载
3. 创建配置验证逻辑（启动时检查 API Key）

### 阶段3：LLM 服务层

1. 定义 `ILlmService` 接口
2. 实现 `AliyunLlmService`（通义千问）
3. 实现 `LlmProviderFactory`（工厂模式）
4. 在模块中注册服务

### 阶段4：基础 Agent 实现

1. 定义 `AgentState` 接口
2. 实现 `AgentController`（SSE 端点）
3. 实现 `AgentService`（基础工作流）
4. 实现 `PlannerNode`（简化版，调用 LLM 解析意图）
5. 实现 `ExecutorNode`（Mock 图片生成）

### 阶段5：SSE 流式响应

1. 实现 SSE 事件推送
2. 实现思考日志推送
3. 实现 GenUI 组件推送

### 阶段6：测试验证

1. 创建启动脚本
2. 验证 API 端点可访问
3. 测试 SSE 流式响应

## 文件结构

```javascript
main/server/
├── package.json
├── tsconfig.json
├── nest-cli.json
├── .env.example
├── src/
│   ├── main.ts
│   ├── app.module.ts
│   ├── llm/
│   │   ├── llm.module.ts
│   │   ├── interfaces/
│   │   │   └── llm-service.interface.ts
│   │   ├── services/
│   │   │   ├── aliyun-llm.service.ts
│   │   │   └── llm-provider-factory.service.ts
│   ├── agent/
│   │   ├── agent.module.ts
│   │   ├── agent.controller.ts
│   │   ├── agent.service.ts
│   │   ├── nodes/
│   │   │   ├── planner.node.ts
│   │   │   └── executor.node.ts
│   │   └── interfaces/
│   │       └── agent-state.interface.ts
│   ├── common/
│   │   └── types/
│   │       └── genui-component.interface.ts
│   └── config/
│       └── configuration.ts
```



## 关键实现点

- 使用 `@langchain/community` 的 `ChatAlibabaTongyi` 实现通义千问