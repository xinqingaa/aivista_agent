---
name: 后端知识库模块完整修复
overview: 修复数据库迁移错误和getAllStyles查询问题，全面审查后端CRUD功能实现，确保系统内置样式保护机制正确工作，并与用户期望进行对比验证。
todos:
  - id: fix-migration
    content: 移除migrateDatabase调用，消除启动错误
    status: completed
  - id: fix-getall
    content: 修复getAllStyles使用query()方法替代零向量search()
    status: completed
  - id: add-getbyid
    content: 添加Service的getStyleById方法并更新Controller
    status: completed
  - id: add-mapper
    content: 添加mapDbRecordToStyleData辅助方法统一字段映射
    status: completed
  - id: fix-queries
    content: 修复updateStyle和isSystemStyle中的search()查询改为query()
    status: completed
  - id: add-constant
    content: 添加SYSTEM_STYLE_IDS常量并替换所有硬编码
    status: completed
  - id: update-tests
    content: 更新单元测试mock支持query()方法
    status: completed
  - id: verify-api
    content: 运行完整的API测试验证所有CRUD功能
    status: in_progress
---

# 后端知识库模块完整修复计划

## 问题诊断

### 核心错误分析

**启动日志错误**：

```
[ERROR] Database migration failed
Error: Failed to convert JavaScript value `Object {...}` into rust type `String`
```

**错误位置**：[`knowledge.service.ts:525-566`](main/server/src/knowledge/knowledge.service.ts)

**根本原因**：

1. `migrateDatabase()` 方法使用 `table.update()` 更新整个对象
2. 对象包含复杂数据结构：

                                                - 已序列化的 `metadata` 字符串
                                                - 包含1536个浮点数的 `vector` 数组
                                                - 混合的 `issystem`/`isSystem` 字段

3. LanceDB的Rust底层无法正确转换这种混合的JavaScript对象

**影响范围**：

- 每次服务器启动都会报错（但不会中断服务）
- 日志污染，影响问题排查
- 潜在的数据损坏风险

### 架构问题诊断

#### 问题1：字段命名不一致

**代码定义**：

```typescript
// initial-styles.ts
interface StyleData {
  isSystem?: boolean;  // 驼峰命名
}
```

**数据库存储**：

```typescript
// insertInitialStyles()
issystem: style.isSystem || false  // 全小写字段名
```

**影响**：查询、更新时字段名不匹配

#### 问题2：getAllStyles查询方式不当

**当前实现**：[`knowledge.service.ts:568-588`](main/server/src/knowledge/knowledge.service.ts)

```typescript
async getAllStyles(): Promise<StyleData[]> {
  const zeroVector = new Array(dimension).fill(0);
  const results = await this.table
    .search(zeroVector)  // ❌ 使用零向量hack
    .limit(10000)
    .toArray();
}
```

**问题**：

- `search()` 是为向量相似度搜索设计的，不是用来查询所有数据
- 零向量hack性能差且不可靠
- 可能返回按"距离"排序的结果，而非预期顺序

**正确方式**（根据LanceDB 2026文档）：

```typescript
async getAllStyles(): Promise<StyleData[]> {
  const results = await this.table
    .query()  // ✅ 使用query()而非search()
    .limit(10000)
    .toArray();
}
```

## 用户期望对比

### 用户明确要求

1. ✅ **新增功能**：支持添加新风格
2. ✅ **编辑功能**：支持更新风格数据
3. ✅ **删除功能**：支持单个删除和批量删除
4. ✅ **保护机制**：现有知识库数据（5个系统样式）不可删除

### 当前实现情况

| 功能 | API端点 | Service方法 | 保护机制 | 状态 |

|------|---------|------------|----------|------|

| 创建 | POST /styles | addStyle() | ✅ | 正常 |

| 读取全部 | GET /styles | getAllStyles() | N/A | ⚠️ 需优化 |

| 读取单个 | GET /styles/:id | - | N/A | ⚠️ 硬编码 |

| 更新 | PUT/PATCH /styles/:id | updateStyle() | ✅ 部分保护 | 正常 |

| 删除单个 | DELETE /styles/:id | deleteStyle() | ✅ | 正常 |

| 批量删除 | POST /batch-delete | deleteStyles() | ✅ | 正常 |

### 发现的问题

#### 问题3：getStyleById未使用数据库

**文件**：[`knowledge.controller.ts:193-220`](main/server/src/knowledge/knowledge.controller.ts)

```typescript
async getStyleById(@Param('id') id: string): Promise<StyleResponseDto> {
  // ❌ 硬编码从INITIAL_STYLES查找
  const { INITIAL_STYLES } = await import('./data/initial-styles');
  const style = INITIAL_STYLES.find((s) => s.id === id);
}
```

**应该**：

```typescript
async getStyleById(@Param('id') id: string): Promise<StyleResponseDto> {
  const style = await this.knowledgeService.getStyleById(id);
  if (!style) {
    throw new NotFoundException(`Style ${id} not found`);
  }
  return style;
}
```

#### 问题4：系统样式保护不完整

**当前保护**：

- ✅ 删除时检查：`isSystemStyle()` 方法
- ⚠️ 更新时部分保护：只允许修改 description、tags、metadata
- ❌ 硬编码系统ID列表：`['style_001', 'style_002', ...]`

**改进建议**：

使用常量统一管理系统样式ID，避免硬编码重复：

```typescript
// knowledge.service.ts 顶部
export const SYSTEM_STYLE_IDS = [
  'style_001', 'style_002', 'style_003', 
  'style_004', 'style_005'
] as const;
```

## 详细修复方案

### 修复1：移除/禁用数据库迁移

**位置**：[`knowledge.service.ts:61-66`](main/server/src/knowledge/knowledge.service.ts)

**当前代码**：

```typescript
async onModuleInit() {
  await this.initialize();
  
  // 执行数据库迁移
  await this.migrateDatabase();
}
```

**修复方案A（推荐）**：完全移除迁移调用

```typescript
async onModuleInit() {
  await this.initialize();
  
  // 数据库迁移已废弃
  // 新初始化的数据库schema已正确，无需迁移
  // await this.migrateDatabase();
}
```

**修复方案B**：添加条件判断

```typescript
async onModuleInit() {
  await this.initialize();
  
  // 仅在数据库已存在且强制迁移时执行
  const needMigration = this.configService.get('ENABLE_DB_MIGRATION') === 'true';
  if (needMigration) {
    await this.migrateDatabase();
  }
}
```

**推荐**：方案A，因为新数据库已经正确，不需要迁移

### 修复2：优化getAllStyles查询

**位置**：[`knowledge.service.ts:568-588`](main/server/src/knowledge/knowledge.service.ts)

**当前实现**（有问题）：

```typescript
async getAllStyles(): Promise<StyleData[]> {
  const dimension = this.embeddingService.getDimension();
  const zeroVector = new Array(dimension).fill(0);
  
  const results = await this.table
    .search(zeroVector)  // ❌ 不正确的方式
    .limit(10000)
    .toArray();
}
```

**修复后**（使用query方法）：

```typescript
async getAllStyles(): Promise<StyleData[]> {
  if (!this.table) {
    this.logger.warn('Table not initialized');
    return [];
  }
  
  try {
    // 使用query()方法查询所有记录（不需要向量）
    const results = await this.table
      .query()
      .limit(10000)
      .toArray();
    
    this.logger.log(`Retrieved ${results.length} styles from database`);
    
    return results.map(result => ({
      id: result.id,
      style: result.style,
      prompt: result.prompt,
      description: result.description,
      tags: result.tags || [],
      metadata: typeof result.metadata === 'string' 
        ? JSON.parse(result.metadata) 
        : result.metadata,
      isSystem: result.issystem || false, // 处理字段名差异
      createdAt: result.createdat || result.createdAt,
      updatedAt: result.updatedat || result.updatedAt,
    }));
  } catch (error) {
    this.logger.error(`Failed to get all styles: ${error.message}`, error.stack);
    return [];
  }
}
```

### 修复3：添加getStyleById方法

**位置**：[`knowledge.service.ts`](main/server/src/knowledge/knowledge.service.ts) - 新增方法

```typescript
/**
 * 根据ID获取单个风格
 */
async getStyleById(id: string): Promise<StyleData | null> {
  if (!this.table) {
    this.logger.warn('Table not initialized');
    return null;
  }
  
  try {
    const results = await this.table
      .query()
      .where(`id = '${id}'`)
      .limit(1)
      .toArray();
    
    if (results.length === 0) {
      return null;
    }
    
    const result = results[0];
    return {
      id: result.id,
      style: result.style,
      prompt: result.prompt,
      description: result.description,
      tags: result.tags || [],
      metadata: typeof result.metadata === 'string' 
        ? JSON.parse(result.metadata) 
        : result.metadata,
      isSystem: result.issystem || false,
      createdAt: result.createdat || result.createdAt,
      updatedAt: result.updatedat || result.updatedAt,
    };
  } catch (error) {
    this.logger.error(`Failed to get style ${id}:`, error);
    return null;
  }
}
```

### 修复4：更新Controller的getStyleById

**位置**：[`knowledge.controller.ts:193-220`](main/server/src/knowledge/knowledge.controller.ts)

**当前**（硬编码）：

```typescript
async getStyleById(@Param('id') id: string): Promise<StyleResponseDto> {
  const { INITIAL_STYLES } = await import('./data/initial-styles');
  const style = INITIAL_STYLES.find((s) => s.id === id);
  if (!style) {
    throw new Error(`Style with id ${id} not found`);
  }
}
```

**修复后**：

```typescript
async getStyleById(@Param('id') id: string): Promise<StyleResponseDto> {
  this.logger.log(`Getting style by id: ${id}`);
  const style = await this.knowledgeService.getStyleById(id);
  
  if (!style) {
    throw new NotFoundException(`Style with id ${id} not found`);
  }
  
  return {
    id: style.id,
    style: style.style,
    prompt: style.prompt,
    description: style.description,
    tags: style.tags,
    metadata: style.metadata,
  };
}
```

### 修复5：统一系统样式ID常量

**位置**：创建新常量并在多处使用

**新增常量**（在 [`knowledge.service.ts`](main/server/src/knowledge/knowledge.service.ts) 顶部）：

```typescript
/**
 * 系统内置样式ID列表
 * 这些样式不可删除，只能修改部分字段
 */
export const SYSTEM_STYLE_IDS = [
  'style_001', // Cyberpunk
  'style_002', // Watercolor
  'style_003', // Minimalist
  'style_004', // Oil Painting
  'style_005', // Anime
] as const;
```

**替换使用位置**：

1. `isSystemStyle()` 方法：
```typescript
private async isSystemStyle(id: string): Promise<boolean> {
  if (SYSTEM_STYLE_IDS.includes(id as any)) {
    return true;
  }
  // ... 其他逻辑
}
```

2. `migrateDatabase()` 方法：
```typescript
const systemIds = SYSTEM_STYLE_IDS;
```


### 修复6：优化字段名映射

**创建辅助方法**：

```typescript
/**
 * 将数据库记录转换为StyleData对象
 * 处理字段名差异（issystem -> isSystem）
 */
private mapDbRecordToStyleData(record: any): StyleData {
  return {
    id: record.id,
    style: record.style,
    prompt: record.prompt,
    description: record.description,
    tags: record.tags || [],
    metadata: typeof record.metadata === 'string' 
      ? JSON.parse(record.metadata) 
      : record.metadata,
    isSystem: record.issystem || record.isSystem || false,
    createdAt: record.createdat || record.createdAt,
    updatedAt: record.updatedat || record.updatedAt,
  };
}
```

**使用位置**：

- `getAllStyles()`
- `getStyleById()`
- `updateStyle()` 的返回值处理

## 后端CRUD功能完整审查

### 功能矩阵

```
操作         | API路由                    | Controller方法   | Service方法      | 保护机制      | 状态
------------ | -------------------------- | ---------------- | ---------------- | ------------- | -------
创建         | POST /styles               | addStyle()       | addStyle()       | 无需保护      | ✅ 正常
读取全部     | GET /styles                | getAllStyles()   | getAllStyles()   | 无需保护      | ❌ 需修复
读取单个     | GET /styles/:id            | getStyleById()   | ❌ 缺失         | 无需保护      | ❌ 需修复
更新完整     | PUT /styles/:id            | updateStyle()    | updateStyle()    | ✅ 部分字段   | ✅ 正常
更新部分     | PATCH /styles/:id          | patchStyle()     | updateStyle()    | ✅ 部分字段   | ✅ 正常
删除单个     | DELETE /styles/:id         | deleteStyle()    | deleteStyle()    | ✅ 完全阻止   | ✅ 正常
批量删除     | POST /batch-delete         | deleteStyles()   | deleteStyles()   | ✅ 逐个检查   | ✅ 正常
```

### 保护机制详细审查

#### 删除保护（完整）

**实现**：[`knowledge.service.ts:384-405`](main/server/src/knowledge/knowledge.service.ts)

```typescript
async deleteStyle(id: string): Promise<void> {
  if (await this.isSystemStyle(id)) {
    throw new ForbiddenException('Cannot delete system built-in style');
  }
  await this.table.delete(`id = '${id}'`);
}
```

**验证**：

- ✅ 系统样式抛出403错误
- ✅ 批量删除时逐个检查
- ✅ 返回failed列表

#### 更新保护（部分）

**实现**：[`knowledge.service.ts:434-494`](main/server/src/knowledge/knowledge.service.ts)

```typescript
async updateStyle(id: string, updateData: UpdateStyleDto): Promise<StyleData> {
  const isSystem = existing.issystem || existing.isSystem || false;

  if (isSystem) {
    const allowedFields = ['description', 'tags', 'metadata'];
    const restrictedFields = Object.keys(updateData).filter(
      key => !allowedFields.includes(key)
    );
    
    if (restrictedFields.length > 0) {
      throw new ForbiddenException(
        `Cannot modify system style fields: ${restrictedFields.join(', ')}`
      );
    }
  }
}
```

**验证**：

- ✅ 系统样式只能修改 description、tags、metadata
- ✅ 尝试修改 style、prompt 会抛出403错误
- ✅ 符合用户期望

## 实施步骤

### 阶段1：修复数据库迁移错误（高优先级）

**步骤1.1**：注释或移除 `migrateDatabase()` 调用

**文件**：[`knowledge.service.ts:61-66`](main/server/src/knowledge/knowledge.service.ts)

```typescript
async onModuleInit() {
  await this.initialize();
  
  // 移除数据库迁移 - 新schema已正确，无需迁移
  // await this.migrateDatabase();
}
```

**步骤1.2**：验证修复

- 重启后端服务器
- 检查启动日志无错误
- 验证数据库正常工作

### 阶段2：优化getAllStyles查询方法

**步骤2.1**：替换为 `query()` 方法

**文件**：[`knowledge.service.ts:568-588`](main/server/src/knowledge/knowledge.service.ts)

**修改前**：

```typescript
const zeroVector = new Array(dimension).fill(0);
const results = await this.table.search(zeroVector).limit(10000).toArray();
```

**修改后**：

```typescript
const results = await this.table.query().limit(10000).toArray();
```

**步骤2.2**：添加辅助映射方法

```typescript
private mapDbRecordToStyleData(record: any): StyleData {
  return {
    id: record.id,
    style: record.style,
    prompt: record.prompt,
    description: record.description || '',
    tags: record.tags || [],
    metadata: typeof record.metadata === 'string' 
      ? JSON.parse(record.metadata) 
      : record.metadata,
    isSystem: record.issystem || false,
  };
}
```

**步骤2.3**：简化getAllStyles实现

```typescript
async getAllStyles(): Promise<StyleData[]> {
  if (!this.table) {
    this.logger.warn('Table not initialized');
    return [];
  }
  
  try {
    const results = await this.table.query().limit(10000).toArray();
    return results.map(r => this.mapDbRecordToStyleData(r));
  } catch (error) {
    this.logger.error('Failed to get all styles:', error);
    return [];
  }
}
```

### 阶段3：添加getStyleById方法

**步骤3.1**：在 Service 中添加方法

```typescript
async getStyleById(id: string): Promise<StyleData | null> {
  if (!this.table) {
    return null;
  }
  
  try {
    const results = await this.table
      .query()
      .where(`id = '${id}'`)
      .limit(1)
      .toArray();
    
    return results.length > 0 
      ? this.mapDbRecordToStyleData(results[0]) 
      : null;
  } catch (error) {
    this.logger.error(`Failed to get style ${id}:`, error);
    return null;
  }
}
```

**步骤3.2**：更新 Controller

**文件**：[`knowledge.controller.ts:193-220`](main/server/src/knowledge/knowledge.controller.ts)

```typescript
async getStyleById(@Param('id') id: string): Promise<StyleResponseDto> {
  this.logger.log(`Getting style by id: ${id}`);
  const style = await this.knowledgeService.getStyleById(id);
  
  if (!style) {
    throw new NotFoundException(`Style with id ${id} not found`);
  }
  
  return {
    id: style.id,
    style: style.style,
    prompt: style.prompt,
    description: style.description,
    tags: style.tags,
    metadata: style.metadata,
  };
}
```

### 阶段4：统一系统样式ID管理

**步骤4.1**：定义常量

在 [`knowledge.service.ts`](main/server/src/knowledge/knowledge.service.ts) 文件顶部（imports之后）：

```typescript
/**
 * 系统内置样式ID列表（不可删除）
 */
export const SYSTEM_STYLE_IDS = [
  'style_001', // Cyberpunk
  'style_002', // Watercolor  
  'style_003', // Minimalist
  'style_004', // Oil Painting
  'style_005', // Anime
] as const;
```

**步骤4.2**：替换硬编码

在以下位置使用常量：

1. `isSystemStyle()` 方法（约500行）
2. `migrateDatabase()` 方法（约545行）
```typescript
// 替换前
const systemIds = ['style_001', 'style_002', ...];

// 替换后
const systemIds = SYSTEM_STYLE_IDS;
```


### 阶段5：修复updateStyle中的字段查询

**位置**：[`knowledge.service.ts:441-443`](main/server/src/knowledge/knowledge.service.ts)

**当前**：

```typescript
const existingStyles = await this.table.search()
  .where(`id = '${id}'`)
  .toArray();
```

**问题**：`search()` 不带参数会报错

**修复**：

```typescript
const existingStyles = await this.table
  .query()
  .where(`id = '${id}'`)
  .limit(1)
  .toArray();
```

### 阶段6：修复isSystemStyle查询

**位置**：[`knowledge.service.ts:510-519`](main/server/src/knowledge/knowledge.service.ts)

**当前**：

```typescript
const styles = await this.table.search()
  .where(`id = '${id}'`)
  .toArray();
```

**修复**：

```typescript
const styles = await this.table
  .query()
  .where(`id = '${id}'`)
  .limit(1)
  .toArray();
```

## 测试验证计划

### 单元测试更新

**文件**：[`knowledge.service.spec.ts`](main/server/src/knowledge/knowledge.service.spec.ts)

需要更新mock以支持 `query()` 方法：

```typescript
const mockTable = {
  query: jest.fn().mockReturnThis(),
  where: jest.fn().mockReturnThis(),
  limit: jest.fn().mockReturnThis(),
  toArray: jest.fn(),
  add: jest.fn(),
  delete: jest.fn(),
  update: jest.fn(),
  countRows: jest.fn(),
};
```

### 功能测试清单

1. **创建功能**

                                                - [ ] 创建自定义样式成功
                                                - [ ] 验证向量自动生成

2. **读取功能**

                                                - [ ] GET /styles 返回所有样式（包括系统和自定义）
                                                - [ ] GET /styles/:id 返回指定样式
                                                - [ ] 不存在的ID返回404

3. **更新功能**

                                                - [ ] 更新自定义样式所有字段
                                                - [ ] 更新系统样式的允许字段（description、tags、metadata）
                                                - [ ] 尝试更新系统样式的style/prompt返回403
                                                - [ ] prompt变化时重新计算向量

4. **删除功能**

                                                - [ ] 删除自定义样式成功
                                                - [ ] 尝试删除系统样式返回403
                                                - [ ] 批量删除正确处理混合情况
                                                - [ ] 批量删除返回准确的 deleted/failed 统计

### API测试命令

```bash
# 1. 获取所有样式
curl http://localhost:3000/api/knowledge/styles

# 2. 获取单个样式
curl http://localhost:3000/api/knowledge/styles/style_001

# 3. 创建新样式
curl -X POST http://localhost:3000/api/knowledge/styles \
  -H "Content-Type: application/json" \
  -d '{
    "id": "custom_001",
    "style": "Test Style",
    "prompt": "test prompt",
    "description": "test description",
    "tags": ["test"]
  }'

# 4. 更新自定义样式
curl -X PATCH http://localhost:3000/api/knowledge/styles/custom_001 \
  -H "Content-Type: application/json" \
  -d '{"description": "updated description"}'

# 5. 尝试更新系统样式的核心字段（应失败）
curl -X PATCH http://localhost:3000/api/knowledge/styles/style_001 \
  -H "Content-Type: application/json" \
  -d '{"style": "Hacked", "prompt": "hacked"}'

# 6. 更新系统样式的允许字段（应成功）
curl -X PATCH http://localhost:3000/api/knowledge/styles/style_001 \
  -H "Content-Type: application/json" \
  -d '{"description": "新的描述"}'

# 7. 删除自定义样式
curl -X DELETE http://localhost:3000/api/knowledge/styles/custom_001

# 8. 尝试删除系统样式（应失败）
curl -X DELETE http://localhost:3000/api/knowledge/styles/style_001

# 9. 批量删除
curl -X POST http://localhost:3000/api/knowledge/styles/batch-delete \
  -H "Content-Type: application/json" \
  -d '{"ids": ["custom_001", "style_001"]}'
```

## 风险评估与缓解

### 风险1：LanceDB版本不支持query()

**检查方式**：

```bash
cd main/server
grep -A 5 "@lancedb/lancedb" package.json
```

**缓解方案**：

如果不支持 `query()`，使用备用方案：

```typescript
// 备用方案：使用filter
const results = await this.table
  .filter("id IS NOT NULL")
  .limit(10000)
  .toArray();
```

### 风险2：现有数据库损坏

**症状**：启动后 count=0 或查询失败

**解决方案**：

1. 删除现有数据库：`rm -rf main/server/data/lancedb`
2. 设置强制初始化：环境变量 `FORCE_INIT_KNOWLEDGE_BASE=true`
3. 重启服务器

### 风险3：字段名映射遗漏

**缓解**：

- 集中使用 `mapDbRecordToStyleData()` 辅助方法
- 避免直接访问 `record.issystem`
- 统一通过 `isSystem` 访问

## 验收标准

### 功能验收

- [ ] 启动日志无错误（无Database migration failed）
- [ ] GET /styles 返回正确数量的样式（至少5个系统样式）
- [ ] GET /styles/:id 正确返回单个样式
- [ ] 可以创建自定义样式
- [ ] 可以更新自定义样式的所有字段
- [ ] 可以更新系统样式的允许字段（description、tags、metadata）
- [ ] 无法更新系统样式的核心字段（style、prompt）- 返回403
- [ ] 可以删除自定义样式
- [ ] 无法删除系统样式 - 返回403
- [ ] 批量删除正确处理系统样式

### 代码质量验收

- [ ] 所有单元测试通过
- [ ] 没有TypeScript类型错误
- [ ] 没有硬编码的魔法值（使用常量）
- [ ] 错误日志清晰准确
- [ ] 代码注释完整

## 实施优先级

### P0 - 立即修复（阻塞性问题）

1. 移除 `migrateDatabase()` 调用 - 消除启动错误
2. 修复 `getAllStyles()` 使用 `query()` - 核心查询功能
3. 添加 `getStyleById()` Service方法 - API功能完整性
4. 更新Controller的 `getStyleById()` - API正确性

### P1 - 重要优化

1. 统一系统样式ID常量
2. 添加 `mapDbRecordToStyleData()` 辅助方法
3. 修复其他使用 `search()` 的查询
4. 更新单元测试的mock

### P2 - 代码优化

1. 添加完整的错误处理
2. 优化日志输出
3. 代码注释完善

## 技术要点总结

### LanceDB查询最佳实践

```typescript
// ✅ 查询所有记录
table.query().limit(N).toArray()

// ✅ 条件查询
table.query().where("condition").limit(N).toArray()

// ❌ 不要用search()查询非向量数据
table.search(vector).toArray()  // 仅用于相似度搜索
```

### 字段名规范

```typescript
// 数据库字段：全小写
issystem, createdat, updatedat

// 应用层字段：驼峰命名
isSystem, createdAt, updatedAt

// 映射处理
isSystem: record.issystem || false
```

### 系统样式保护模式

```typescript
// 1. 常量定义
export const SYSTEM_STYLE_IDS = [...] as const;

// 2. 删除保护：完全阻止
if (SYSTEM_STYLE_IDS.includes(id)) {
  throw new ForbiddenException('Cannot delete system style');
}

// 3. 更新保护：字段级控制
const allowedFields = ['description', 'tags', 'metadata'];
if (isSystem && hasRestrictedFields(updateData, allowedFields)) {
  throw new ForbiddenException('Cannot modify core fields');
}
```