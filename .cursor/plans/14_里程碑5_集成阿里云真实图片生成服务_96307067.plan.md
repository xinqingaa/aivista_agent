# Milestone 5: 集成阿里云真实图片生成服务

## 一、目标

集成阿里云 DashScope 图片生成服务，支持文生图和局部重绘功能，实现 Mock 和真实服务的无缝切换。

**核心目标：**

- 创建图片生成服务接口（类似 ILlmService）
- 实现 AliyunImageService（使用 DashScope SDK）
- 支持三个模型：qwen-image-max、qwen-image-plus、qwen-image-edit-plus
- 在 Executor Node 中集成，支持配置开关（Mock/Real）
- 测试一次真实调用后切回 Mock
- 前端完成后可切换为真实服务

**成本说明：**

- qwen-image-max: 0.5元/张（100张免费额度，90天内有效）
- qwen-image-plus: 0.2元/张
- qwen-image-edit-plus: 用于局部重绘（价格需确认）

## 二、架构设计

### 2.1 服务接口设计

参考现有的 LLM 服务接口设计，创建图片生成服务接口：

```typescript
// src/image/interfaces/image-service.interface.ts
export interface ImageGenerationOptions {
  model?: string; // qwen-image-max | qwen-image-plus
  size?: string; // 图片尺寸，如 "1024x1024"
  n?: number; // 生成图片数量（默认 1）
}

export interface ImageEditOptions {
  model?: string; // qwen-image-edit-plus
  imageUrl?: string; // 原图 URL
  maskBase64?: string; // 蒙版 Base64
  size?: string;
}

export interface IImageService {
  // 文生图
  generateImage(prompt: string, options?: ImageGenerationOptions): Promise<string>;
  
  // 局部重绘
  editImage(prompt: string, options: ImageEditOptions): Promise<string>;
}
```

### 2.2 实现架构

```
Executor Node
    ↓
IImageService (接口)
    ↓
AliyunImageService (DashScope SDK)
    ↓
DashScope API (qwen-image-*)
```

## 三、实施任务清单

### 任务 1: 安装依赖包

**文件**: `main/server/package.json`

**操作**: 添加 DashScope SDK 依赖

```bash
npm install @alicloud/dashscope --save
```

**预计工作量**: 5 分钟

---

### 任务 2: 创建图片生成服务接口

**文件**: `main/server/src/image/interfaces/image-service.interface.ts`（新建）

**功能**: 定义图片生成服务接口，支持文生图和局部重绘

**接口定义**:

```typescript
export interface ImageGenerationOptions {
  model?: 'qwen-image-max' | 'qwen-image-plus';
  size?: string; // 如 "1024x1024", "1024x768" 等
  n?: number; // 生成数量，默认 1
}

export interface ImageEditOptions {
  model?: 'qwen-image-edit-plus';
  imageUrl: string; // 原图 URL
  maskBase64: string; // 蒙版 Base64
  size?: string;
}

export interface IImageService {
  generateImage(prompt: string, options?: ImageGenerationOptions): Promise<string>;
  editImage(prompt: string, options: ImageEditOptions): Promise<string>;
}
```

**预计工作量**: 30 分钟

---

### 任务 3: 实现 AliyunImageService

**文件**: `main/server/src/image/services/aliyun-image.service.ts`（新建）

**功能**: 使用 DashScope SDK 调用阿里云图片生成 API

**实现要点**:

1. 使用 `@alicloud/dashscope` SDK
2. 调用 `imagesGeneration` API（文生图）
3. 调用 `imageSynthesis` API（局部重绘，如支持）
4. 处理 API 响应，返回图片 URL
5. 错误处理和重试机制

**代码结构**:

```typescript
import { ApiKey, ImagesGeneration } from '@alicloud/dashscope';
import { ConfigService } from '@nestjs/config';
import { IImageService, ImageGenerationOptions, ImageEditOptions } from '../interfaces/image-service.interface';

@Injectable()
export class AliyunImageService implements IImageService {
  private readonly apiKey: string;
  private readonly defaultModel: string;

  constructor(private configService: ConfigService) {
    this.apiKey = this.configService.get<string>('DASHSCOPE_API_KEY') || '';
    this.defaultModel = this.configService.get<string>('ALIYUN_IMAGE_MODEL') || 'qwen-image-plus';
  }

  async generateImage(prompt: string, options?: ImageGenerationOptions): Promise<string> {
    // 调用 DashScope imagesGeneration API
    // 返回图片 URL
  }

  async editImage(prompt: string, options: ImageEditOptions): Promise<string> {
    // 调用 DashScope imageSynthesis API（如支持）
    // 返回图片 URL
  }
}
```

**API 调用示例**（需要根据实际 DashScope SDK 文档调整）:

```typescript
import { ApiKey, ImagesGeneration } from '@alicloud/dashscope';

const apiKey = new ApiKey({ apiKey: this.apiKey });
const imagesGeneration = new ImagesGeneration({ apiKey });

const response = await imagesGeneration.call({
  model: options?.model || this.defaultModel,
  prompt: prompt,
  n: options?.n || 1,
  size: options?.size || '1024x1024',
});

// 返回图片 URL
return response.output.results[0].url;
```

**预计工作量**: 2-3 小时（需要查阅 DashScope SDK 文档，测试 API 调用）

---

### 任务 4: 实现 MockImageService（可选，或修改现有逻辑）

**文件**: `main/server/src/image/services/mock-image.service.ts`（新建）或修改 `executor.node.ts`

**功能**: Mock 图片生成服务，保持现有功能

**选择方案**:

- **方案 A**: 创建独立的 MockImageService，实现 IImageService 接口
- **方案 B**: 在 Executor Node 中保留现有 Mock 逻辑，通过配置开关选择

**推荐**: 方案 A（创建独立服务，代码更清晰）

**预计工作量**: 30 分钟

---

### 任务 5: 创建 ImageModule

**文件**: `main/server/src/image/image.module.ts`（新建）

**功能**: 图片服务模块，类似 LlmModule

**代码结构**:

```typescript
@Module({
  providers: [
    {
      provide: 'IMAGE_SERVICE',
      useFactory: (configService: ConfigService) => {
        const useRealService = configService.get<boolean>('USE_REAL_IMAGE_SERVICE') ?? false;
        if (useRealService) {
          return new AliyunImageService(configService);
        } else {
          return new MockImageService();
        }
      },
      inject: [ConfigService],
    },
  ],
  exports: ['IMAGE_SERVICE'],
})
export class ImageModule {}
```

**预计工作量**: 30 分钟

---

### 任务 6: 更新 Executor Node

**文件**: `main/server/src/agent/nodes/executor.node.ts`

**变更内容**:

1. 注入 IImageService
2. 根据 action 类型调用相应方法
3. 保持现有 Mock 逻辑作为降级方案

**代码变更**:

```typescript
@Injectable()
export class ExecutorNode {
  constructor(
    @Inject('IMAGE_SERVICE') private readonly imageService: IImageService,
  ) {}

  async execute(state: AgentState): Promise<Partial<AgentState>> {
    // ... 现有代码
    
    let imageUrl: string;
    
    switch (action) {
      case 'generate_image':
        // 调用图片生成服务
        imageUrl = await this.imageService.generateImage(prompt, {
          model: this.configService.get('ALIYUN_IMAGE_MODEL') || 'qwen-image-plus',
          size: '1024x1024',
        });
        break;
      
      case 'inpainting':
        if (!state.userInput.maskData) {
          throw new Error('Inpainting requires maskData');
        }
        // 调用图片编辑服务
        imageUrl = await this.imageService.editImage(prompt, {
          model: 'qwen-image-edit-plus',
          imageUrl: state.userInput.maskData.imageUrl,
          maskBase64: state.userInput.maskData.base64,
          size: '1024x1024',
        });
        break;
      
      default:
        throw new Error(`Unknown action: ${action}`);
    }
    
    // ... 其余代码
  }
}
```

**预计工作量**: 1 小时

---

### 任务 7: 更新 AgentModule

**文件**: `main/server/src/agent/agent.module.ts`

**变更内容**: 导入 ImageModule

```typescript
@Module({
  imports: [LlmModule, KnowledgeModule, ImageModule], // 添加 ImageModule
  // ...
})
```

**预计工作量**: 5 分钟

---

### 任务 8: 添加配置项

**文件**: `main/server/src/config/configuration.ts` 和 `.env.example`

**新增配置**:

```typescript
// 是否使用真实图片生成服务（默认 false，使用 Mock）
USE_REAL_IMAGE_SERVICE?: boolean;

// 阿里云图片生成模型（默认 qwen-image-plus）
ALIYUN_IMAGE_MODEL?: 'qwen-image-max' | 'qwen-image-plus';

// 图片生成尺寸（默认 1024x1024）
ALIYUN_IMAGE_SIZE?: string;
```

**预计工作量**: 30 分钟

---

### 任务 9: 测试真实服务调用

**操作步骤**:

1. 设置环境变量：`USE_REAL_IMAGE_SERVICE=true`
2. 确保 `DASHSCOPE_API_KEY` 已配置
3. 发送测试请求，验证 API 调用成功
4. 检查返回的图片 URL 是否有效
5. 验证后切回 Mock：设置 `USE_REAL_IMAGE_SERVICE=false`

**测试用例**:

- 文生图：测试 `generate_image` action
- 局部重绘：测试 `inpainting` action（如支持）

**预计工作量**: 1 小时

---

### 任务 10: 更新文档

**文件**:

- `main/server/docs/workflow/WORKFLOW_GUIDE.md`
- `main/server/docs/development/DEVELOPMENT_ROADMAP.md`
- 新建 `main/server/docs/design/IMAGE_SERVICE_DESIGN.md`

**更新内容**:

1. 添加图片生成服务说明
2. 添加配置项说明
3. 添加成本说明
4. 更新 Milestone 5 状态

**预计工作量**: 1 小时

---

## 四、技术要点

### 4.1 DashScope SDK 使用

**安装**:

```bash
npm install @alicloud/dashscope --save
```

**导入**:

```typescript
import { ApiKey, ImagesGeneration } from '@alicloud/dashscope';
```

**API 调用**（需要根据实际 SDK 文档调整）:

```typescript






const apiKey = new ApiKey({ apiKey: 'your-api-key' });
const imagesGeneration = new ImagesGeneration({ apiKey });

const response = await imagesGeneration.call({
  model: 'qwen-image-plus',
  prompt: 'a cat in cyberpunk style',
  n: 1,
  size: '1024x1024',
});
```

### 4.2 错误处理

- API 调用失败时返回友好错误信息
- 支持重试机制（可选）
- 失败时降级到 Mock（可选，根据需求）

### 4.3 成本控制

- 默认使用 Mock，避免测试时产生费用
- 提供配置开关，开发/生产环境分别配置
- 记录 API 调用次数，便于成本监控（可选）

---

## 五、实施顺序

### 第一阶段：基础实现（2-3 小时）

1. ✅ 任务 1: 安装依赖包
2. ✅ 任务 2: 创建图片生成服务接口
3. ✅ 任务 3: 实现 AliyunImageService（核心）
4. ✅ 任务 4: 实现 MockImageService

### 第二阶段：集成（1-2 小时）

5. ✅ 任务 5: 创建 ImageModule
6. ✅ 任务 6: 更新 Executor Node
7. ✅ 任务 7: 更新 AgentModule
8. ✅ 任务 8: 添加配置项

### 第三阶段：测试和文档（2 小时）

9. ✅ 任务 9: 测试真实服务调用（测试一次后切回 Mock）
10. ✅ 任务 10: 更新文档

**总预计工作量**: 5-7 小时

---

## 六、注意事项

### 6.1 API 调用限制

- 注意 API 的速率限制
- 合理设置超时时间
- 实现重试机制（可选）

### 6.2 成本控制

- 测试时使用 Mock，避免产生费用
- 生产环境通过配置开关控制
- 记录调用次数，监控成本

### 6.3 图片 URL 处理

- 确认返回的图片 URL 格式
- 图片是否需要下载到本地（根据需求）
- URL 的有效期问题（如有时效性）

### 6.4 错误处理

- API 调用失败时的降级策略
- 网络超时处理
- 图片生成失败时的用户提示

---

## 七、测试计划

### 7.1 单元测试

- 测试 AliyunImageService 的 API 调用
- 测试 MockImageService 的返回结果
- 测试错误处理逻辑

### 7.2 集成测试

- 测试 Executor Node 集成图片服务
- 测试配置开关（Mock/Real）切换
- 测试文生图和局部重绘流程

### 7.3 真实服务测试

- 测试一次真实 API 调用（验证通过后切回 Mock）
- 验证返回的图片 URL 是否有效
- 验证错误处理逻辑

---

## 八、后续优化（可选）

1. **缓存机制**: 相同 Prompt 缓存生成的图片，避免重复调用
2. **批量生成**: 支持一次生成多张图片
3. **图片优化**: 图片压缩、格式转换等
4. **成本监控**: 记录 API 调用次数和费用
5. **异步处理**: 图片生成改为异步任务（如需要）