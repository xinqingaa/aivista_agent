# 补充环境变量配置并修复水印问题

## 一、问题分析

### 1.1 缺少的环境变量

通过检查代码和配置文件，发现以下环境变量在configuration.ts中已定义，但在.env和.env.example中缺失：

**Critic相关配置（3个）**：

- `CRITIC_PASS_THRESHOLD`: 质量审查通过阈值（默认0.7）
- `CRITIC_USE_LLM`: 是否使用LLM进行质量审查（默认false）
- `MAX_RETRY_COUNT`: 最大重试次数（默认3）

**RAG相关配置（2个，可选但建议添加）**：

- `RAG_MIN_SIMILARITY`: RAG检索最小相似度阈值（默认0.4）
- `RAG_SEARCH_LIMIT`: RAG检索结果数量限制（默认3）

**已存在但需要确认的配置**：

- `CRITIC_TIMEOUT`: 已在.env中存在，但需要确认.env.example中也有

### 1.2 水印问题分析

从日志看到：

```
[AliyunImageService] AliyunImageService: Request to DashScope - model: qwen-image-plus, size: 1024*1024, prompt: "...", prompt_extend: true, watermark: true
```

但.env中配置的是：

```
ALIYUN_IMAGE_WATERMARK=false
```

**可能的原因**：

1. 环境变量格式问题（注释、空格等）
2. 配置未正确加载
3. 代码逻辑问题（但代码看起来是正确的）

**代码逻辑检查**：

- `AliyunImageService`构造函数中：`this.defaultWatermark = this.configService.get<boolean>('ALIYUN_IMAGE_WATERMARK') ?? false;`
- `generateImageInternal`方法中：`const watermark = options?.watermark ?? this.defaultWatermark;`

代码逻辑正确，问题可能是配置加载或格式问题。

## 二、实施任务

### 任务1: 在.env中添加缺少的Critic配置

**文件**: `main/server/.env`

**添加位置**: 在"性能配置"部分的CRITIC_TIMEOUT之后

**新增配置**:

```bash
# Critic 节点配置
CRITIC_TIMEOUT=8
CRITIC_PASS_THRESHOLD=0.7
CRITIC_USE_LLM=false
MAX_RETRY_COUNT=3
```

### 任务2: 在.env中添加RAG配置（可选但建议）

**文件**: `main/server/.env`

**添加位置**: 在"向量数据库配置"部分之后，或新建"RAG检索配置"部分

**新增配置**:

```bash


# ============================================
# RAG 检索配置
# ============================================
RAG_MIN_SIMILARITY=0.4
RAG_SEARCH_LIMIT=3
```

### 任务3: 在.env.example中添加所有缺少的配置

**文件**: `main/server/.env.example`

**添加位置**: 按照.env的结构，在相应位置添加

**需要添加的配置**:

1. Critic配置（在性能配置部分）
2. RAG配置（新建部分或放在向量数据库配置之后）

### 任务4: 检查并修复水印配置问题

**文件**: `main/server/.env`

**检查项**:

1. 确认`ALIYUN_IMAGE_WATERMARK=false`格式正确（无多余空格、注释符号等）
2. 如果配置正确但仍然显示true，可能需要重启服务或检查配置加载逻辑

**可能的修复**:

- 确保配置值前后无空格
- 确保配置行未被注释
- 如果问题持续，检查NestJS ConfigModule的配置加载顺序

## 三、配置项说明

### 3.1 Critic配置说明

- **CRITIC_PASS_THRESHOLD** (number, 默认0.7): 质量审查通过阈值，分数>=此值则通过
- **CRITIC_USE_LLM** (boolean, 默认false): 是否使用LLM进行真实质量审查，false时使用简化逻辑
- **MAX_RETRY_COUNT** (number, 默认3): 质量审查未通过时的最大重试次数
- **CRITIC_TIMEOUT** (number, 默认8): Critic节点执行超时时间（秒）

### 3.2 RAG配置说明

- **RAG_MIN_SIMILARITY** (number, 默认0.4): 向量检索的最小相似度阈值，低于此值的结果将被过滤
- **RAG_SEARCH_LIMIT** (number, 默认3): 向量检索返回的最大结果数量

### 3.3 图片生成配置说明

- **ALIYUN_IMAGE_WATERMARK** (boolean, 默认false): 是否在生成的图片上添加水印

## 四、实施顺序

1. 在.env中添加Critic配置
2. 在.env中添加RAG配置
3. 在.env.example中添加所有缺少的配置
4. 检查并修复.env中的水印配置格式
5. 验证配置是否正确（可以通过重启服务查看日志）

## 五、注意事项

1. **配置格式**：

   - 布尔值使用`true`/`false`（小写，无引号）
   - 数字直接写数字，无需引号
   - 确保每行配置前后无多余空格

2. **配置位置**：

   - 按照逻辑分组（Critic配置放在性能配置部分，RAG配置单独成组）
   - 保持.env和.env.example的一致性

3. **水印问题**：

   - 如果配置正确但问题仍存在，可能需要重启服务
   - 检查是否有其他配置文件覆盖了.env的设置

4. **向后兼容**：

   - 所有配置项都有默认值，即使不配置也能正常工作
   - 添加配置不会影响现有功能

## 六、验证方法

配置完成后，可以通过以下方式验证：

1. **重启服务**：查看启动日志，确认配置加载
2. **查看日志**：测试请求，查看日志中的配置值

   - Critic Node日志应显示正确的passThreshold、useLlm、retryCount
   - RAG Node日志应显示检索结果数量（受RAG_SEARCH_LIMIT限制）
   - AliyunImageService日志应显示watermark: false（如果配置正确）

3. **测试场景**：

   - 测试质量审查功能（查看Critic Node日志）
   - 测试RAG检索功能（查看检索结果数量）
   - 测试图片生成（查看生成图片是否无水印）