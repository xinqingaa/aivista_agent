---
name: 工作流符合性分析和优化建议
overview: 分析当前实现是否符合工作流设计文档，识别问题和优化点，提出具体的改进建议和下一步实施计划。
todos: []
---

# 工作流符合性分析和优化建议

## 1. 当前实现符合性分析

### 1.1 符合设计的部分

**工作流节点执行顺序**：

- ✅ Planner Node → RAG Node → Executor Node（符合 Milestone 3 设计）
- ✅ 所有节点都正确执行并更新状态
- ✅ SSE 事件流正确推送

**RAG 检索功能**：

- ✅ 成功检索到相关风格（Cyberpunk、Anime、Minimalist）
- ✅ 相似度计算正确（0.48, 0.41, 0.41）
- ✅ 使用增强后的 Prompt

**数据流转**：

- ✅ AgentState 在各节点间正确传递
- ✅ enhancedPrompt 对象结构正确

### 1.2 发现的问题

**问题 1: Executor 节点日志顺序错误**

- **现象**: 日志显示先推送"任务执行完成"，然后才推送"开始执行任务"
- **位置**: `agent.service.ts` 第 105-115 行
- **原因**: 进度提示在 Executor 节点执行后才推送，应该在执行前推送

**问题 2: RAG 检索结果相关性**

- **现象**: 检索到 Anime 和 Minimalist，与"赛博朋克"相关性较低
- **原因**: 查询文本包含"猫"等通用词，可能稀释了风格关键词的权重
- **影响**: 虽然 Cyberpunk 排第一，但其他风格可能不够相关

**问题 3: 缺少 enhancedPrompt 详细信息**

- **现象**: SSE 事件流中没有推送 enhancedPrompt 的详细信息
- **影响**: 前端无法看到检索到的风格和相似度信息

**问题 4: 缺少 Critic Node（Milestone 4）**

- **设计**: 完整工作流应该包含质量审查节点
- **当前**: 直接执行后返回结果，没有质量检查

## 2. 优化建议

### 2.1 立即修复（高优先级）

#### 优化 1: 修复 Executor 节点日志顺序

**文件**: `main/server/src/agent/agent.service.ts`

**问题**: 进度提示在节点执行后才推送

**修复方案**:

- 在 Executor 节点执行前推送"开始执行任务"日志
- 可以通过检查节点名称和状态来判断是否即将执行 Executor

#### 优化 2: 在 SSE 事件中推送 enhancedPrompt 信息

**文件**: `main/server/src/agent/agent.service.ts`

**方案**: 当 RAG 节点执行后，推送 enhancedPrompt 的详细信息作为单独的 SSE 事件

```typescript
// 在 RAG 节点执行后
if (nodeName === 'rag' && update.enhancedPrompt) {
  yield {
    type: 'enhanced_prompt',
    timestamp: Date.now(),
    data: update.enhancedPrompt,
  };
}
```

### 2.2 改进建议（中优先级）

#### 优化 3: 改进 RAG 查询文本构建

**文件**: `main/server/src/agent/nodes/rag.node.ts`

**当前问题**: 查询文本包含太多通用词（如"猫"、"生成"），可能稀释风格关键词

**优化方案**:

- 优先使用 `intent.style`，如果存在则主要使用风格关键词
- 减少通用词的权重
- 或者使用加权查询：`风格关键词 * 2 + 主题 + 原始文本`

#### 优化 4: 添加检索结果过滤

**文件**: `main/server/src/agent/nodes/rag.node.ts`

**方案**: 如果检索到的风格与用户意图的风格不匹配，可以过滤掉

```typescript
// 如果用户指定了特定风格，优先匹配该风格
if (state.intent.style) {
  const styleEnglish = this.styleMap[state.intent.style];
  // 优先选择匹配的风格
  const matchedStyles = results.filter(r => 
    r.style.toLowerCase() === styleEnglish?.toLowerCase()
  );
  if (matchedStyles.length > 0) {
    results = matchedStyles;
  }
}
```

### 2.3 功能增强（低优先级，Milestone 4）

#### 优化 5: 实现 Critic Node

**文件**: `main/server/src/agent/nodes/critic.node.ts` (新建)

**功能**:

- 质量审查：检查生成结果是否符合用户意图
- 重试机制：如果质量不达标，可以重新执行 Executor
- 最多重试 3 次

#### 优化 6: 添加工作流元数据事件

**文件**: `main/server/src/agent/agent.service.ts`

**方案**: 推送工作流执行元数据（节点执行时间、总耗时等）

## 3. 实施优先级

### 高优先级（立即修复）

1. 修复 Executor 节点日志顺序
2. 在 SSE 事件中推送 enhancedPrompt 信息

### 中优先级（近期优化）

3. 改进 RAG 查询文本构建
4. 添加检索结果过滤逻辑

### 低优先级（Milestone 4）

5. 实现 Critic Node
6. 添加工作流元数据事件

## 4. 符合性总结

**当前实现符合 Milestone 3 设计**：

- ✅ 工作流节点顺序正确
- ✅ RAG 检索功能正常
- ✅ SSE 事件流推送正确
- ✅ 数据流转符合设计

**需要改进的地方**：

- ⚠️ Executor 节点日志顺序
- ⚠️ 缺少 enhancedPrompt 详细信息推送
- ⚠️ RAG 检索结果相关性可以提升
- ⚠️ 缺少 Critic Node（Milestone 4）

## 5. 下一步建议

1. **立即修复**: 修复日志顺序和添加 enhancedPrompt 事件
2. **优化 RAG**: 改进查询文本构建，提高检索相关性
3. **Milestone 4**: 实现 Critic Node 和完整的工作流循环