# 会话与 AI 回复缓存

## 一、问题与根因

### 现象

- 切换对话后只有用户问题，没有 AI 回答（含思考过程、GenUI 组件）。
- 数据库里部分会话只有 user 消息，没有 assistant 消息；SSE 推送数据正常。

### 根因（两阶段）

**1. onChatEnd 闭包陈旧**

`onChatEnd` 使用闭包里的 `genUIComponents`。`stream_end` 与最后几个 `gen_ui_component` 在同一事件循环内同步触发，React 的 setState 仅入队未执行，闭包中的 `genUIComponents` 仍是本轮开始时清空后的 `[]`，导致 `saveAssistantMessage` 几乎总是收到空数组。

**2. genUIComponentsRef 更新时机错误**

即便引入 ref，若在 **setState 的 updater 内** 更新 ref，React 18 会批量执行 updater（在 commit 阶段），而 `stream_end` 已同步调用 `onChatEnd()`，此时 ref 仍未更新，仍为 `[]`。

**3. 加载路径破坏 ref 语义**

`loadCurrentSession` 在开头清空 `genUIComponentsRef`、在加载成功后用本次加载结果覆盖 ref，会导致：流式期间切换会话时 ref 被清空或覆盖，`onChatEnd` 读到空或错误会话的数据。

**4. 加载竞态**

快速切换会话时，先发起的 load 可能后完成，覆盖后选中的会话状态。

**5. 流式期间切换会话导致保存到错误会话**

若用户在流式过程中切换会话，`onChatEnd` 使用的 `currentSessionId` 可能已是新会话，导致把本轮回复保存到错误会话。

---

## 二、修复方案（已实施）

### 2.1 ref 仅表示“当前流式回合要保存的组件”

- **加载路径**：不再清空、不再覆盖 `genUIComponentsRef`。加载只更新 state（`setMessages` / `setGenUIComponents`）。
- **onChatStart**：每轮新对话开始时 `genUIComponentsRef.current = []`。
- **addGenUIComponent / updateGenUIComponent**：**先** 用 `genUIComponentsRef.current` 算出 `next`，**先** `genUIComponentsRef.current = next`，**再** `setGenUIComponents(next)`，保证同一 tick 内 `onChatEnd` 能读到最新列表。
- **onChatEnd**：从 `genUIComponentsRef.current` 读取并调用 `MessageService.saveAssistantMessage`。

### 2.2 发送时记录会话 ID

- 新增 `sessionIdWhenSendRef`，在 `handleSend` 中 `sessionIdWhenSendRef.current = currentSessionId`。
- `onChatEnd` 使用 `sessionIdWhenSendRef.current` 作为保存目标会话，避免流式期间切换导致写错会话。

### 2.3 加载竞态

- 在 `loadCurrentSession` 的 async 内：进入时 `sessionIdAtStart = currentSessionId`，`await loadSessionMessages` 完成后若 `currentSessionId !== sessionIdAtStart` 则不 setState，直接 return。

### 2.4 保存成功后刷新侧边栏

- `onChatEnd` 中 `saveAssistantMessage` 成功后调用 `loadSessions()`，使侧边栏 lastMessage 立即更新。

---

## 三、涉及文件

| 文件 | 修改要点 |
|------|----------|
| [chat-interface.tsx](main/web/components/chat/chat-interface.tsx) | genUIComponentsRef、sessionIdWhenSendRef；add/update 中先同步更新 ref 再 setState；onChatStart 清空 ref；onChatEnd 从 ref 取数并保存，成功后 loadSessions；loadCurrentSession 不碰 ref、完成后校验 sessionId。 |
| [message-service.ts](main/web/lib/services/message-service.ts) | updateSessionInfo 只取最后一条 user 消息作为 lastMessage（见 03-侧边栏与会话项）。 |

---

## 四、验证

- 发一条消息 → 等 AI 完整回复 → 切到另一会话再切回：能看到该条用户消息 + 完整 AI 回复（含 GenUI）。
- 快速连续切换多个会话：最终界面与当前选中的会话一致。
- 流式期间切换会话：本轮回复仍保存到发送时的会话。
